generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Answer {
  id               String   @id @default(uuid())
  responseId       String
  questionId       String
  selectedOptionId String?
  answerValue      String?
  Question         Question     @relation(fields: [questionId], references: [id])
  QuizResponse     QuizResponse @relation(fields: [responseId], references: [id], onDelete: Cascade)

  @@index([questionId])
  @@index([responseId])
}

model AuditLog {
  id               String   @id @default(uuid())
  adminId    String
  action     String
  targetType String
  targetId   String?
  oldValue   String?
  newValue   String?
  reason     String?
  createdAt  DateTime @default(now())
  User       User     @relation(fields: [adminId], references: [id])

  @@index([action])
  @@index([adminId])
  @@index([createdAt])
  @@index([targetType, targetId])
}

model BlockedEmail {
  id               String   @id @default(uuid())
  email     String   @unique
  reason    String?
  blockedAt DateTime @default(now())
  blockedBy String
  User      User     @relation(fields: [blockedBy], references: [id])

  @@index([blockedBy])
  @@index([email])
}

model Comment {
  id               String   @id @default(uuid())
  quizId        String
  userId        String
  content       String
  createdAt     DateTime      @default(now())
  updatedAt        DateTime @updatedAt
  parentId      String?
  Comment       Comment?      @relation("CommentToComment", fields: [parentId], references: [id], onDelete: Cascade)
  other_Comment Comment[]     @relation("CommentToComment")
  Quiz          Quiz          @relation(fields: [quizId], references: [id], onDelete: Cascade)
  User          User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  CommentLike   CommentLike[]

  @@index([createdAt])
  @@index([parentId])
  @@index([quizId])
  @@index([userId])
}

model CommentLike {
  id               String   @id @default(uuid())
  commentId String
  userId    String
  createdAt DateTime @default(now())
  Comment   Comment  @relation(fields: [commentId], references: [id], onDelete: Cascade)
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([commentId, userId])
  @@index([commentId])
  @@index([userId])
}

model Community {
  id               String   @id @default(uuid())
  name            String
  description     String?
  coverImage      String?
  isPublic        Boolean           @default(true)
  creatorId       String
  createdAt       DateTime          @default(now())
  updatedAt        DateTime @updatedAt
  User            User              @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  CommunityMember CommunityMember[]
  Quiz            Quiz[]

  @@index([createdAt])
  @@index([creatorId])
  @@index([name])
  @@index([isPublic])
  @@index([isPublic, createdAt])
}

model CommunityMember {
  id               String   @id @default(uuid())
  userId      String
  communityId String
  role        CommunityRole @default(MEMBER)
  joinedAt    DateTime      @default(now())
  Community   Community     @relation(fields: [communityId], references: [id], onDelete: Cascade)
  User        User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, communityId])
  @@index([communityId])
  @@index([userId])
}

model Conversation {
  id               String   @id @default(uuid())
  type                    String                    @default("direct")
  createdAt               DateTime                  @default(now())
  updatedAt        DateTime @updatedAt
  lastMessageAt           DateTime                  @default(now())
  ConversationParticipant ConversationParticipant[]
  Message                 Message[]

  @@index([lastMessageAt(sort: Desc)])
}

model ConversationParticipant {
  id               String   @id @default(uuid())
  conversationId String
  userId         String
  joinedAt       DateTime     @default(now())
  lastReadAt     DateTime     @default(now())
  isArchived     Boolean      @default(false)
  isMuted        Boolean      @default(false)
  Conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  User           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([conversationId, userId])
  @@index([conversationId])
  @@index([userId, lastReadAt])
}

model EarlyAdopter {
  id               String   @id @default(uuid())
  email             String    @unique
  notified          Boolean   @default(false)
  createdAt         DateTime  @default(now())
  interests         String[]  @default([])
  name              String?
  notifiedAt        DateTime?
  referralSource    String?
  signupCompleted   Boolean   @default(false)
  signupCompletedAt DateTime?

  @@index([createdAt])
  @@index([email])
  @@index([notified])
  @@index([signupCompleted])
}

model Follow {
  id               String   @id @default(uuid())
  followerId                    String
  followingId                   String
  createdAt                     DateTime @default(now())
  User_Follow_followerIdToUser  User     @relation("Follow_followerIdToUser", fields: [followerId], references: [id], onDelete: Cascade)
  User_Follow_followingIdToUser User     @relation("Follow_followingIdToUser", fields: [followingId], references: [id], onDelete: Cascade)

  @@unique([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
}

model Message {
  id               String   @id @default(uuid())
  conversationId  String
  senderId        String
  content         String
  contentType     String            @default("text")
  metadata        Json?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime?
  deletedAt       DateTime?
  status          MessageStatus     @default(SENT)
  Conversation    Conversation      @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  User            User              @relation(fields: [senderId], references: [id], onDelete: Cascade)
  MessageReaction MessageReaction[]
  MessageRead     MessageRead[]
  MessageReport   MessageReport[]

  @@index([conversationId, createdAt])
  @@index([senderId])
}

model MessageReaction {
  id               String   @id @default(uuid())
  messageId String
  userId    String
  emoji     String
  createdAt DateTime @default(now())
  Message   Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([messageId, userId, emoji])
  @@index([messageId])
  @@index([userId])
}

model MessageRead {
  id               String   @id @default(uuid())
  messageId String
  userId    String
  readAt    DateTime @default(now())
  Message   Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([messageId, userId])
  @@index([messageId, userId])
}

model MessageReport {
  id               String   @id @default(uuid())
  messageId   String
  reportedBy  String
  reason      String
  description String?
  status      MessageReportStatus @default(PENDING)
  createdAt   DateTime            @default(now())
  reviewedBy  String?
  reviewedAt  DateTime?
  Message     Message             @relation(fields: [messageId], references: [id], onDelete: Cascade)
  User        User                @relation(fields: [reportedBy], references: [id], onDelete: Cascade)

  @@index([messageId])
  @@index([reportedBy])
  @@index([status])
}

model Notification {
  id               String   @id @default(uuid())
  userId      String
  type        NotificationType
  actorId     String?
  actorName   String?
  actorAvatar String?
  quizId      String?
  quizTitle   String?
  commentId   String?
  commentText String?
  message     String
  actionUrl   String?
  isRead      Boolean          @default(false)
  createdAt   DateTime         @default(now())
  User        User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([userId, createdAt])
  @@index([userId, isRead])
}

model Question {
  id               String   @id @default(uuid())
  quizId              String
  questionText        String
  questionType        QuestionType
  orderIndex          Int
  personalityOutcomes Json?
  imageUrl            String?
  Answer              Answer[]
  Quiz                Quiz             @relation(fields: [quizId], references: [id], onDelete: Cascade)
  QuestionOption      QuestionOption[]

  @@index([quizId])
}

model QuestionOption {
  id               String   @id @default(uuid())
  questionId        String
  optionText        String
  isCorrect         Boolean  @default(false)
  points            Int      @default(0)
  orderIndex        Int
  personalityWeight Json?
  imageUrl          String?
  Question          Question @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@index([questionId])
}

model Quiz {
  id               String   @id @default(uuid())
  title              String
  description        String?
  coverImage         String?
  category           String
  tags               String[]          @default([])
  status             QuizStatus        @default(PUBLISHED)
  isPublic           Boolean           @default(true)
  settings           Json              @default("{}")
  randomizeQuestions Boolean           @default(false)
  randomizeAnswers   Boolean           @default(false)
  timeLimit          Int?
  allowRetakes       Boolean           @default(true)
  showCorrectAnswers Boolean           @default(true)
  requireLogin       Boolean           @default(false)
  communityId        String?
  createdAt          DateTime          @default(now())
  updatedAt        DateTime @updatedAt
  creatorId          String
  Comment            Comment[]
  Question           Question[]
  Community          Community?        @relation(fields: [communityId], references: [id])
  User               User              @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  QuizLike           QuizLike[]
  QuizRating         QuizRating[]
  QuizResponse       QuizResponse[]
  SocialMediaPost    SocialMediaPost[]

  @@index([category])
  @@index([communityId])
  @@index([createdAt])
  @@index([creatorId])
  @@index([status, category])
  @@index([status, createdAt])
  @@index([status])
  @@index([title])
}

model QuizLike {
  id               String   @id @default(uuid())
  quizId    String
  userId    String
  createdAt DateTime @default(now())
  Quiz      Quiz     @relation(fields: [quizId], references: [id], onDelete: Cascade)
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([quizId, userId])
  @@index([quizId])
  @@index([userId])
}

model QuizRating {
  id               String   @id @default(uuid())
  quizId    String
  userId    String
  rating    Int
  review    String?
  createdAt DateTime @default(now())
  updatedAt        DateTime @updatedAt
  Quiz      Quiz     @relation(fields: [quizId], references: [id], onDelete: Cascade)
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([quizId, userId])
  @@index([quizId])
  @@index([userId])
}

model QuizResponse {
  id               String   @id @default(uuid())
  quizId      String
  userId      String?
  score       Int?
  resultType  String?
  completedAt DateTime @default(now())
  Answer      Answer[]
  Quiz        Quiz     @relation(fields: [quizId], references: [id])
  User        User?    @relation(fields: [userId], references: [id])

  @@index([completedAt])
  @@index([quizId])
  @@index([userId])
}

model SocialMediaConnection {
  id               String   @id @default(uuid())
  userId                  String
  platform                SocialMediaPlatform
  tumblrBlogName          String?
  tumblrOAuthToken        String?
  tumblrOAuthSecret       String?
  facebookPageId          String?
  facebookPageName        String?
  facebookAccessToken     String?
  facebookPageAccessToken String?
  isActive                Boolean             @default(true)
  lastSyncedAt            DateTime?
  createdAt               DateTime            @default(now())
  updatedAt        DateTime @updatedAt
  User                    User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  SocialMediaPost         SocialMediaPost[]

  @@unique([userId, platform, facebookPageId])
  @@unique([userId, platform, tumblrBlogName])
  @@index([isActive])
  @@index([platform])
  @@index([userId])
}

model SocialMediaPost {
  id               String   @id @default(uuid())
  quizId                String
  connectionId          String
  platform              SocialMediaPlatform
  externalPostId        String
  externalUrl           String?
  publishedAt           DateTime              @default(now())
  lastSyncedAt          DateTime?
  likes                 Int                   @default(0)
  shares                Int                   @default(0)
  comments              Int                   @default(0)
  views                 Int                   @default(0)
  SocialMediaConnection SocialMediaConnection @relation(fields: [connectionId], references: [id], onDelete: Cascade)
  Quiz                  Quiz                  @relation(fields: [quizId], references: [id], onDelete: Cascade)

  @@unique([connectionId, externalPostId])
  @@index([connectionId])
  @@index([platform])
  @@index([publishedAt])
  @@index([quizId])
}

model User {
  id               String   @id @default(uuid())
  email                               String                    @unique
  username                            String                    @unique
  displayName                         String
  password                            String
  avatarUrl                           String?
  bio                                 String?
  role                                UserRole                  @default(USER)
  isBlocked                           Boolean                   @default(false)
  blockedReason                       String?
  blockedAt                           DateTime?
  blockedBy                           String?
  subscriptionTier                    SubscriptionTier          @default(FREE)
  subscriptionId                      String?
  subscriptionEnds                    DateTime?
  isVerified                          Boolean                   @default(false)
  storageUsed                         Int                       @default(0)
  quizzesCreatedToday                 Int                       @default(0)
  lastQuizCreatedAt                   DateTime?
  createdAt                           DateTime                  @default(now())
  updatedAt        DateTime @updatedAt
  instagramHandle                     String?
  interests                           String[]                  @default([])
  location                            String?
  pronouns                            String?
  tiktokHandle                        String?
  tumblrHandle                        String?
  twitterHandle                       String?
  website                             String?
  facebookHandle                      String?
  AuditLog                            AuditLog[]
  BlockedEmail                        BlockedEmail[]
  Comment                             Comment[]
  CommentLike                         CommentLike[]
  Community                           Community[]
  CommunityMember                     CommunityMember[]
  ConversationParticipant             ConversationParticipant[]
  Follow_Follow_followerIdToUser      Follow[]                  @relation("Follow_followerIdToUser")
  Follow_Follow_followingIdToUser     Follow[]                  @relation("Follow_followingIdToUser")
  Message                             Message[]
  MessageReaction                     MessageReaction[]
  MessageRead                         MessageRead[]
  MessageReport                       MessageReport[]
  Notification                        Notification[]
  Quiz                                Quiz[]
  QuizLike                            QuizLike[]
  QuizRating                          QuizRating[]
  QuizResponse                        QuizResponse[]
  SocialMediaConnection               SocialMediaConnection[]
  UserBlock_UserBlock_blockedIdToUser UserBlock[]               @relation("UserBlock_blockedIdToUser")
  UserBlock_UserBlock_blockerIdToUser UserBlock[]               @relation("UserBlock_blockerIdToUser")

  @@index([createdAt])
  @@index([displayName])
  @@index([email])
  @@index([username])
}

model UserBlock {
  id               String   @id @default(uuid())
  blockerId                      String
  blockedId                      String
  reason                         String?
  createdAt                      DateTime @default(now())
  User_UserBlock_blockedIdToUser User     @relation("UserBlock_blockedIdToUser", fields: [blockedId], references: [id], onDelete: Cascade)
  User_UserBlock_blockerIdToUser User     @relation("UserBlock_blockerIdToUser", fields: [blockerId], references: [id], onDelete: Cascade)

  @@unique([blockerId, blockedId])
  @@index([blockedId])
  @@index([blockerId])
}

enum CommunityRole {
  OWNER
  MODERATOR
  MEMBER
}

enum MessageReportStatus {
  PENDING
  REVIEWED
  RESOLVED
}

enum MessageStatus {
  SENDING
  SENT
  DELIVERED
  FAILED
}

enum NotificationType {
  COMMENT_ON_QUIZ
  COMMENT_REPLY
  QUIZ_TAKEN
  QUIZ_LIKED
  NEW_FOLLOWER
  QUIZ_MILESTONE
  FOLLOWED_USER_QUIZ
  NEW_MESSAGE
}

enum QuestionType {
  MULTIPLE_CHOICE
  PERSONALITY
  POLL
  RATING
}

enum QuizStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum SocialMediaPlatform {
  TUMBLR
  FACEBOOK
}

enum SubscriptionTier {
  FREE
  PRO
  PREMIUM
}

enum UserRole {
  USER
  ADMIN
  SUPER_ADMIN
}
